DevelperGuide
========================================================================================

はじめに
========================================================================================

本書ではChOWDERの開発方法について解説します.

開発環境
========================================================================================

### サーバサイド
 - redis
 - node.js

### クライアントサイド
 - webpack+babel

サーバとクライアントの役割
========================================================================================
### サーバの役割
 - HTTP 通信 - クライアントに対して HTML ページなどを送信する
 - Websocket 通信 - websocketにより, クライアントのコントローラ及びディスプレイとの間で通信を行う
 - データベース入出力 - クライアントから送信された画像データやテキストデータを redis に保存し, 永続化する.
 - サーバサイドレンダリング - 送信された URL のウェブサイトを phantomjs を用いてサーバサイドでレンダリングし, png 画像として保存する.
 - 各種アクセス権限の設定を行う.
 - WebRTCでの動画配信の通信の仲介を行う.

### クライアント - コントローラの役割
 - コントローラは, 複数のディスプレイの配置を制御したり, ディスプレイに配信するコンテンツの登録/削除等の制御をサーバに問い合わせて行うことができる.
 - また, Administrator権限がある場合は, コンテンツ配信許可不許可などの, 権限設定を行うことができる.

### クライアント - ディスプレイの役割
 - 自身のウィンドウをディスプレイとしてサーバへ登録する.
 - 配信されたコンテンツを表示する.

デバッグ方法
========================================================================================

### サーバサイド
ChOWDERサーバを`bin/run.bat`等で起動した後, 
`RedisDesktopManager`等で, reidsに登録したデータを簡単に閲覧できます
   > https://github.com/uglide/RedisDesktopManager


### クライアントサイド
クライアントサイドでは, `webpack`, 及び `babel`を使用し, Javascriptコードのトランスコンパイルを行っています.

ChOWDERサーバを`bin/run.bat`等で起動しした後, 
```
npm run watch
```
コマンドにより, `public/`以下のクライアントサイドのファイルの変更を検知し, 変更があれば`webpack`が走るようになります.
この状態で開発すると効率的に開発できます.
`webpack`が走ったあとは, ブラウザを手動でのリロードする必要があります.

または, 手動で以下のコマンドを実行することで`webpack`が走ります.
```
npm run webpack
```

全体的な設計
========================================================================================

ChOWDERは[Flux](https://github.com/facebook/flux/tree/master/examples/flux-concepts)をベースにした設計となっており, 下図のような呼び出しフローになっている.

![全体的な設計](image/chowder_201903.png)

ChOWDERで行うほとんどの操作は, `action.js`に記載してあり, 例えばGUIを追加して任意の操作を行いたい場合は, GUIからaction.jsに定義された関数を呼び出すことになる.

また, `store.js`がデータを保持し, ビジネスロジックを実行するが, サーバサイドのRedisDBこそが真のStoreであるので, クライアントサイドのstore.jsはキャッシュとして振舞っている.

`GUI`については, 本来ShadowDOMなどを使用するべきであるが, ChOWDERではもともと(古い)pure jsで開発していたため, その流れを汲んでShadowDOMは使用せず, 各部品を`component`として分離させている.

サーバのフォルダ構成
========================================================================================

<img src="image/server_folders.png" height="280" />

サーバでは, `server/server.js`がエントリーポイントとなっている.
APIに相当するコマンドが, `command.js`に定義されており, それらの実装が`operator/`以下に入っている.


クライアントのフォルダ構成
========================================================================================

<img src="image/client_folders.png" height="500" />

クライアントサイドの公開HTMLページは以下の通り
 - `index.html` : トップページ
 - `controller.html` : コントローラのページ
 - `display.html` : ディスプレイのページ

コントローラ, ディスプレイから, `webpack`により生成された`controller.bundle.js`, `display.bundle.js`をそれぞれ読み込んでいる.

また, `js/controller_app.js`及び`js/display_app.js`がwebpack用エントリーポイントとなっている.

ソースコードは, `public/src/js/`に以下のように入っている.
  - `controller` : コントローラのソース
  - `display` : ディスプレイのソース
  - `components` : GUIのコンポーネント
  - `common` : コントローラ, ディスプレイで共通で使うソース


